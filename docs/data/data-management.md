# Data Management (Flow, Slice)

> Related source files:
> - [base/base2.py](https://github.com/a12910/space-map/blob/ad208055/base/base2.py)
> - [base/root.py](https://github.com/a12910/space-map/blob/ad208055/base/root.py)
> - [flow/afFlowMultiCenter3.py](https://github.com/a12910/space-map/blob/ad208055/flow/afFlowMultiCenter3.py)
> - [flow/flowExport.py](https://github.com/a12910/space-map/blob/ad208055/flow/flowExport.py)
> - [flow/flowImport.py](https://github.com/a12910/space-map/blob/ad208055/flow/flowImport.py)
> - [flow/outputs.py](https://github.com/a12910/space-map/blob/ad208055/flow/outputs.py)
> - [matches/siftFind.py](https://github.com/a12910/space-map/blob/ad208055/matches/siftFind.py)

## Introduction

The data management components of SpaceMap provide infrastructure for importing, organizing, processing, and exporting tissue section data. Flow and Slice are the core data management components for the 3D tissue reconstruction workflow.

For more about the transformation system, see: [Registration System (LDDMM)](../registration/registration-system-(lddmm).md) and [Grid Transformations](../grid/grid-transformations.md).

## Overview

- **Flow Class**: Responsible for data import (FlowImport) and export (FlowExport)
- **Slice Class**: Manages individual sections and their related data

Together, they build a data lifecycle management framework for the entire tissue reconstruction process.

## Class Structure and Relationships

- FlowImport: Initializes data processing workflow, creates Slice objects and configures global coordinate system
- FlowExport: Exports processing results, including transformation parameters and processed images
- Slice: Data structure for individual sections, managing points, images, transformations, etc.
- TransformDB: Unified management of affine and grid transformations, supporting batch application

## Data Flow

Data flows through the SpaceMap system as follows:
1. Import data, initialize sections
2. Process (registration, feature extraction, etc.)
3. Export results
4. Apply transformations to new data

## Key Components and Methods

### FlowImport
- `init_xys(xys, ids=None)`: Initialize sections based on coordinate arrays, automatically calculate coordinate range and resolution, save global parameters
- `auto_init()`: Read parameters from conf.json, reconstruct section objects
- `init_from_codex(csvPath)`: Support CODEX format data import
- Global parameters:
  - `XYRANGE`: Data coordinate range
  - `XYD`: Coordinate transformation resolution

### FlowExport
- `export_affine_grid(affineShape=None, gridKey1="final_ldm", gridKey2="img", save=None)`: Export affine and grid transformations, support saving as NPZ
- `export_imgs(key, mchannel=True, he=False, scale=False)`: Export processed images for all sections, support multi-channel and H&E
- `import_imgs(key, imgs)`: Import external images and distribute to sections

### Slice
- Manages single section's points, images, transformations, etc.
- Supports point coordinate image generation, affine/grid transformation application, disk I/O
- Bridges data management and registration systems

### TransformDB
- Unified interface for managing affine and grid transformations
- `apply_img(img, index)`: Apply transformation to image
- `apply_point(p, index, maxShape=None)`: Apply transformation to point coordinates
- `apply_imgs(imgs)`/`apply_points(ps)`: Batch processing

## Data Storage Structure

```
basePath/
├── conf.json        # Global configuration parameters
├── imgs/            # Processed images
├── outputs/         # Transformation outputs
├── raw/             # Raw input data
└── logs/            # Logs
```

- conf.json stores core parameters like XYRANGE, XYD

## Multi-resolution Processing

Supports multi-resolution processing through dynamic XYD parameter adjustment, balancing large data efficiency and detail preservation.

## File Formats

| Format | Description           | Usage                          |
|--------|----------------------|--------------------------------|
| NPZ    | Compressed numpy arrays| Store transformation matrices and grids|
| JSON   | Configuration files  | Store global parameters and section info|
| Images | PNG, TIFF, etc.      | Input/output images            |
| CSV    | Tabular data         | External data import (e.g., CODEX)|

## Integration with Other Components

- Registration System: Uses sections as data containers, writes transformation results
- Feature Matching: Operates on images generated by Slice
- Grid Transformations: Generated transformations stored and applied through data management system

---

> For reference source code and detailed implementation, please see the related source files above. 